name: Database Backup

on:
  schedule:
    - cron: '0 2 * * 0'   # Jeden Sonntag um 02:00 UTC
  workflow_dispatch:        # Manuell auslösbar über GitHub UI

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Datenbank-Backup via Supabase REST API
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python3 << 'EOF'
          import requests, json, os, sys
          from datetime import datetime
          from pathlib import Path

          url = os.environ["SUPABASE_URL"].rstrip("/")
          key = os.environ["SUPABASE_SERVICE_ROLE_KEY"]
          timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
          backup_dir = Path(f"backup_{timestamp}")
          backup_dir.mkdir()

          headers = {
              "apikey": key,
              "Authorization": f"Bearer {key}",
              "Accept": "application/json",
          }

          tables = [
              "subscriptions",
              "user_profiles",
              "finanzvergleich_calculations",
              "finanzvergleich_singlepayment",
              "finanzvergleich_bestadvice",
              "finanzvergleich_pensiongap",
          ]

          for table in tables:
              print(f"Exportiere: {table}")
              r = requests.get(
                  f"{url}/rest/v1/{table}?select=*",
                  headers=headers,
                  timeout=30,
              )
              if not r.ok:
                  print(f"FEHLER bei {table}: HTTP {r.status_code} – {r.text}")
                  sys.exit(1)
              data = r.json()
              (backup_dir / f"{table}.json").write_text(json.dumps(data, indent=2, ensure_ascii=False))
              print(f"  → {len(data)} Zeilen exportiert")

          print(f"\nAlle Tabellen gesichert in {backup_dir}/")
          EOF

          tar -czf "rentencheck_backup_$(date +%Y%m%d_%H%M%S).tar.gz" backup_*/
          echo "Fertig."

      - name: Backup als Artifact hochladen
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_id }}
          path: "*.tar.gz"
          retention-days: 90
